\subsection{\ChDesc\ Merging}
\label{sec:chdescs:merge}

\Kudos\ drastically reduces the number of \chdescs\ created to
describe a system of changes by (conservatively) identifying when a
second \chdesc\ may safely be written at the same time as an existing
\chdesc\ and, instead of creating the second \chdesc, updating the
existing \chdesc's disk change and dependencies; in effect, merging
the two \chdescs.
%
In this section we describe overlapping \chdesc\ merging; after
introducing \nrb\ \chdescs\ in the next section we describe
two additional merge opportunties.
%
All three merge rules build on invariant~\ref{cdinvar:add-before}
and use fast, conservative checks during \chdesc\ creation to identify
\chdescs\ that will be possible to write together;
%
the merge rules differ in their conservatively applicable conditions.

\subsubsection{\Nrb\ \ChDesc\ Merging}
\label{sec:chdescs:nrb-merge}
Recall from \S\ref{sec:chdescs:nrb} that to write any \chdesc\ on a given
block, all \nrb\ \chdescs\ on the block must also be written. 
%
These implicit dependencies complicate determining whether a block can
be written, requiring a search for non-ready \nrb\ \chdescs.
%
By merging \nrb\ \chdescs\ together and by merging existing \rb\
\chdescs\ into the block's \nrb\ \chdesc\ when the \nrb\ \chdesc\ is
created,
%
\Kudos\ ensures that there is at most one \nrb\ \chdesc\ per block and
that all \chdescs\ on the same block depend on the \nrb\
\chdesc\,
%
and so avoids dependency complication and further reduces \chdesc\
memory overhead.

While any two \nrb\ \chdescs\ on the same block will be written
together, to merge the \chdescs\ the dependencies involving the merged
\chdescs\ must be transformed to preserve the non-merged system's
semantics.  Sections~\ref{sec:chdescs:nrb-merge:hard-hard}
and~\ref{sec:chdescs:nrb-merge:hard-soft} discuss these
transformations.

Mention?:
%
\Nrb\ \chdescs, \rb\ \chdescs, and ready lists:
%
all post-\nrb\ created \chdescs\ depend on \nrb\ because of overlaps.
%
no \nrb-prior created \chdescs\ exist (\rb{}\(\rightarrow\)\nrb{}).
%
single \nrb.

\paragraph{\Nrb-\Nrb\ \ChDesc\ Merging}
\label{sec:chdescs:nrb-merge:hard-hard}
% Although merging two \chdescs\ will not induce block-level dependency
% cycles, without sufficient care merging could induce \chdesc-level
% dependency cycles.  A trivial example is merging \p{q} into \p{p} when
% \p{q} has an explicit dependency on \p{p}; the combined \p{(p+q)}
% should not and need not depend on itself.
To preserve the non-merged dependency semantics when merging a new
\nrb\ \chdesc\ \p{q} into an existing \nrb\ \chdesc\ \p{p}, the merged
\p{(p+q)} must depend on the union of \p{p} and \p{q}'s transitive
\befores.
%
From \chdesc\ invariant~\ref{cdinvar:add-before} and the \nrb\
\chdesc\ creation rule, the only possible dependencies involving \p{p}
and \p{q} are those show in Figure~\ref{fig:nrb-merge}\todo{Should we
  give these deductions or a flavor?}.
%
An algorithm to transform dependencies for \nrb\ \chdesc\ merges
follows from these possible dependencies.
%
Notice, for example, that the dependency paths that could become a
cycle upon the merge of \p{p} of \p{q} involve only \noop\ \chdescs\
and that \chdesc\ invariant~\ref{cdinvar:add-before} ensures these
\noop\ \chdesc\ will not gain data \chdesc\ \befores.
%
TODO: explain further?

\begin{figure}[htb]
  \centering
  \includegraphics[width=\columnwidth]{nrb_merge}
  \caption{Possible dependencies when merging \nrb\ \chdesc\ \p{q}
    into existing \nrb\ \chdesc\ \p{p}.}
  \label{fig:nrb-merge}
\end{figure}\todo{Show Figure~\ref{fig:nrb-merge} without \nrb{}-\rb\ merging's results?}

\noindent Algorithm called on \p{q} and \p{p}:\\
Input: \chdesc\ \p{a} and existing \nrb\ \chdesc\ \p{p}.\\
Returns: whether \indirdepends{a}{p} exists. \(\forall\! \p{b}\!: \indirdepends{a}{b}\) and \notindirdepends{b}{p}, creates \indirdepends{p}{b}.

\begin{itemize}
\item If \p{a} is external, return ``no path to \p{p}.''
\item If \p{a} equals \p{p}, return ``path to \p{p}.''
\item Call self on \p{a} and \p{p}.
\item If \p{a} has no path to \p{p}, return ``no path to \p{p}.''
\item For each \p{a} \before\ \p{b}:
  \begin{itemize}
    \item If \p{b} has no path to \p{p}:
      \begin{itemize}
      \item Move \p{b} from a \before\ of \p{a} to a \before\ of \p{p}.
      \end{itemize}
  \end{itemize}
\end{itemize}

\cdinvar{one-nrb}{Each block has at most one \nrb\ \chdesc\todo{Introduce}.}

\paragraph{\Nrb-\Rb\ \ChDesc\ Merging}
\label{sec:chdescs:nrb-merge:hard-soft}
A block \block{b} may contain a \nrb\ \chdesc\ that depends on \rb\ \chdescs\
(also on \block{b}).
%
For example, the block may gain an initial (\nrb{}) \chdesc, gain
external \afters\ on its \chdesc, accumulate additional (\rb{})
\chdescs, write the subset of its \chdescs\ with external \afters\
(leaving some \rb\ \chdescs\ on the block), and then gain a \nrb\
\chdesc.
%
These \rb\ and \nrb\ \chdescs\ must be written together to satisfy
their (explicit and implicit) dependencies.
%
As in Section~\ref{sec:chdescs:nrb-merge:hard-hard}, \Kudos\ merges
such \chdescs\ to avoid the complications of such implicit
dependencies.  When a new \nrb\ \chdesc\ is to be created, any
existing \rb\ \chdescs\ are first merged into a \nrb\ \chdesc\
and the new \nrb\ \chdesc\ is merged into it.

\noindent Algorithm:
\begin{itemize}
\item Choose some (\rb{}) \chdesc\ \p{a} such that
\(\forall\! b\!: \indirdepends{a}{b}, \blockof{b} \ne \blockof{a}\).
The oldest \chdesc\ on the block will be such a block.
\item Call \nrb-\nrb\ \before\ move algorithm on each \chdesc\ \p{b}
on the block s.t. \(b \ne a\) and convert \p{b} into \anoop\ \chdesc.
\item Convert \p{a} into a \nrb\ \chdesc\ (free it's previous data copy)
that directly depends on only \p{a}.
\end{itemize}

TODO: explain why this preserves dependency semantics? Show possible
dependencies? For the paper, free \chdescs\ instead of convert them
into \noop{}s? (Must modify \nrb-\nrb\ algo usage.)


At the end of \chdesc\ optimizations, say something along the lines:
%
The dynamic optimizations facilitated through \nrb\
\chdescs\ implement the efficiency in systems using soft updates or
journaling\todo{Actually do this for journaling} while expressing
changes modularly through structural descriptions rather than through
internal and semantic file system descriptions.

\todo{Should we talk about why we allow NRBs and merging to be
  disabled? (Debugging simplicity and depend add to \noop\ \chdescs\
  with \afters\ bug catching.)}

\subsubsection{Overlap \ChDesc\ Merging}
\label{sec:chdescs:overlap-merge}
Bitmap blocks and inode size fields accumulate many nearby and
overlapping mergeable \chdescs\ as data is appended to or truncated
from a file.
%
Many of these and similar \chdescs\ are mergeable and have
dependencies that allow simple (and fast) reasoning to identify many
of the mergeable pairs: two \chdescs\ on block $B$ that overlap no other \chdescs\ in \ChMemB{B}
and which have no dependency path from the new to the existing \chdesc\
will not induce a block-level cycle and so are writeable together.
We know that \textit{later} changes will not cause them to induce a block-level cycle due to
invariant~\ref{cdinvar:add-before} and by not merging if the new \chdesc\
has a before and the before is marked as allowed to violate
invariant~\ref{cdinvar:add-before}.
%
While path existence testing is expensive, a conservative path test
of only a depth of two identifies most mergeable \chdescs. If the new
\chdesc\ has an explicit \before\ that is not the existing \chdesc\ and
this \before\ has a \before, then there may be a path to the existing
\chdesc.
%
To merge two such overlapping \chdescs, add the new \chdesc's explicit
before to the existing \chdesc\ (if any and if not the existing \chdesc).
