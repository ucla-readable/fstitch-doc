% -*- mode: latex; tex-main-file: "paper.tex" -*-

\paragraph{Journaling}
\label{sec:using:journal}

In a journaling file system, changes to disk structures are grouped into
\emph{transactions} that commit atomically.
%
Any change in a transaction is first copied into an on-disk journal.
%
A single \emph{commit record} block is written to the journal once the
transaction's changes are stably committed there.
%
This record commits the transaction itself, allowing its changes to be
written into the main body of the file system in any order.
%
If the system crashes, the journal information is used to recover the main
file system from its possibly-incomplete state.
%
Once all the transaction's changes are written, a \emph{completion record}
is written to the journal to mark the transaction as complete; that portion
of the journal may now be reused.

\begin{comment}
the journal point the transaction itself has the commit record
has been written, the changes (which collectively are called a
\emph{transaction}) are considered to have been made to the file system: if
the system crashes, the data from the journal will be copied into the main
file system as part of recovery. After the commit record has been written,
the original changes may be written in any order desired, and once they
have been written, the commit record may be erased and the portion of the
journal storing the data it referenced can be reused.
\end{comment}

The \Kudos\ journal module sits below a regular file system and transforms
incoming \patches\ into journal transactions.
%
Data \patches\ are copied into the journal; a commit record depends on the
journal patches; and the original file system patches depend in turn on the
commit record.
%
The dependencies among the original \patches\ are removed since the journal
itself provides consistency for each high-level file system operation.
%
The journal format is similar to ext3's~\cite{tweedie98journaling}: a
transaction contains a list of block numbers, the data to be written to
those blocks, and finally a single commit record.
%
Figure~\ref{fig:journal} shows how the journal module transforms the
\patches\ in Figure~\ref{fig:softupdate} into journaling semantics.
%
Note that the journal must modify existing \patches' direct dependencies;
this is allowed since the new dependencies will never introduce a
block-level cycle.

\begin{comment}
Almost all of this description of journaling translates directly into \chdesc\
dependencies. The incoming \chdescs\ must be rearranged to implement the new
structure, but for the most part this transformation is straightforward. There
are two special considerations which the journal \module\ must address, however.

First, with soft updates, \chdescs\ can always be written to the disk when
flushing the cache, while the journal must be able to ``lock'' \chdescs\ into
the cache while transactions are in progress. To accomplish this, the journal
\module\ uses a managed \noop\ \chdesc, as outlined in
Section~\ref{sec:patch:noop}.

Second, the commit record is created at the end of the transaction, but the file
system changes created during the transaction must be made to depend on it.
Ordinarily this is not permitted (see \S\ref{sec:patch:nrb}). The condition for
violating this rule is a static proof that no cycle can result from doing so
(immediately or in the future); we have determined this to be the case for the
journal \module\ by hand.
\end{comment}

\begin{figure}
  \centering
  \includegraphics[width=\hsize]{fig/figures_2}
  \caption{\label{fig:journal} Journal \chdesc\ subgraph for the
    change in Figure~\ref{fig:softupdate}. The unlabeled circles are
    \noop\ \chdescs.}
\end{figure}

\begin{comment}
Figure~\ref{fig:journal} shows the \chdesc\ configuration which is created
by applying the journal transformation to the \chdescs\ in
Figure~\ref{fig:softupdate}. The original four \chdescs\ have been
modified to depend on a journal commit record (via \anoop\ \chdesc), and
no longer have explicit dependencies on each other. The commit record
depends on journal blocks containing copies of the changes. Finally, the
commit record can be marked as completed once the original four \chdescs\
have been written. This transformation is performed incrementally as
\chdescs\ arrive. 
\end{comment}

\begin{comment}
Due to this design, the journal \module\ is completely independent of any
specific file system. It is a block device \module\ that automatically journals
whatever file system is stored on it. In fact, the incoming \chdescs\ need not
be arranged for soft updates, or for that matter in any particular configuration
at all.
\end{comment}


Our journal module prototype ignores incoming dependencies
and enforces transactions based on high-level file system operations.
%
It is thus uniformly enforces a particular journal semantics---namely, that
each file system operation happens atomically---regardless of the semantics
specified by the file system above it.
%
It should be possible, however, to extend the journal module to obey
dependencies.
