\subsection{Journaling}
\label{sec:consistency:journal}

Although \chdescs\ might initially seem to be specifically designed to implement
soft updates-like consistency semantics, they are in fact much more flexible and
can be used to implement journaling as well. In a journaling file system,
changes to disk structures are written to a journal before being written to the
main file system area on the disk, and a single disk block (the \emph{commit
record}) is written after the journal is written. Once the commit record has
been written, the changes (which collectively are called a \emph{transaction})
are considered to have been made to the file system: if the system crashes, the
data from the journal will be copied into the main file system as part of
recovery. After the commit record has been written, the original changes may be
written in any order desired, and once they have been written, the commit record
may be erased and the portion of the journal storing the data it referenced can
be reused.

Almost all of this description of journaling translates directly into \chdesc\
dependencies. The incoming \chdescs\ must be rearranged to implement the new
structure, but for the most part this transformation is straightforward. There
are two special situations which the journal \module\ must handle, however.
First, with soft updates, \chdescs\ can always be written to the disk in order
to empty the cache, while the journal must be able to ``lock'' \chdescs\ into
the cache while transactions are in progress. Second, the commit record is
created at the very end of the transaction, but the file system changes created
during the transaction (and thus before it) must be made to depend on it.
Ordinarily this is not allowed, in order to prevent cycles.

To accomplish the first of these tasks, the journal \module\ advertises a
managed \noop\ \chdesc\ (\S\ref{sec:design:chdescs:noop}) to \modules\ above it,
which they must make all changes they create depend on. This special \chdesc\ is
not considered satisfied until the journal \module\ explicitly satisfies it, so
no changes which depend on it will be written from the cache.  At the end of the
transaction, the journal \module\ satisfies this \chdesc, allowing all the
changes to be written to disk.

To accomplish the second task, a special flag is used to override the normal
rule prohibiting the addition of new dependencies to a \chdesc\ after it is
created. The condition for using this flag is a static proof that no cycle can
result from its use (immediately or in the future); we have determined this to
be the case for the journal \module\ by hand.

\begin{figure}
  \centering
  \includegraphics[width=\hsize]{fig/figures_2}
  \caption{\label{fig:journal} Journal \chdesc\ graph for the
    change in Figure~\ref{fig:softupdate}. Empty circles are
    ``\noop'' \chdescs\ with no associated block data.}
\end{figure}

Figure~\ref{fig:journal} shows the \chdesc\ configuration which is created by
applying this transformation to the \chdescs\ in Figure~\ref{fig:softupdate}.
The original four \chdescs\ have been modified to depend on a journal commit
record, and no longer have explicit dependencies on each other. The commit
record depends on blocks journal blocks containing copies of the changes.
Finally, a the commit record can be marked as completed once the original four
\chdescs\ have been written. This transformation is performed incrementally as
\chdescs\ arrive. The resulting journal on disk is similar in format to those
generated by ext3~\cite{tweedie98journaling} -- it has a list of block numbers,
followed by the data which should be in those blocks. Finally, there is a commit
record which applies to the whole set.

A particularly nice property of this arrangement is that the journal \module\ is
completely independent of any specific file system. It is a block device
\module\ that automatically journals whatever file system is stored on it.
Further, by changing our journal \module\ to journal only \chdescs\ that modify
file system metadata -- and by adding additional dependencies to prevent
premature reuse of blocks -- we could even obtain metadata-only journaling (as
opposed to the full data journaling described here). The extra \chdesc\
dependencies would serve the same purpose as the special hooks and corner cases
surrounding reuse of blocks discussed in \cite{tweedie00ext3}. The journal
\module\ can automatically identify metadata \chdescs\ because of the \LFS\
interface described in \S\ref{sec:design:interfaces}, and the UHFS module which
is responsible for writing to all non-metadata blocks. Other block device
layering systems, like GEOM~\cite{geom} or JBD in Linux, would or do need
special hooks into file system code to determine what disk changes represent
metadata in order to do metadata-only journaling. \Chdescs\ and the \LFS\
interface allow us to do this automatically.
