\subsection {Interfaces}
\label{sec:modules:interfaces}

A complete \Kudos\ configuration is composed of many \modules. New \modules\ are
simple to write, and by changing the \module\ arrangement, a broad range of
behaviors can be implemented. It's also easy to tell what behavior a given
arrangement will give just by looking at the connections between the \modules.

\Kudos\ has three major types of \modules.
%
Closest to the disk are block device (BD) \modules, which have a fairly
conventional block device interface with interfaces such as ``read block'' and
``flush''. 
%
Closest to the system call interface are \emph{common file system} (CFS)
\modules, which have an interface similar to VFS~\cite{kleiman86vnodes}. 
%
In traditional systems, a CFS-like \module\ would be connected directly to a
BD-like \module\ in order to set up a file system for mounting. In \Kudos,
however, there is an intermediate interface which interposes between block
devices and the high-level CFS interface.
%
This \emph{low-level file system} (\LFS) interface helps divide file system
implementations into common (reusable) code and file system specific code. A
\Kudos\ file system designer combines modules with all three interfaces in many
ways -- a departure from stackable file systems, which act only at the VFS/CFS
layer. \Kudos\ \modules\ are implemented in C using structures of function
pointers to achieve object oriented behavior, very much like the rest of the
Linux kernel.

\begin{figure}[thb]
\vskip-14pt
\begin{tabular}{@{\hskip0.25in}p{2in}@{}}
\begin{scriptsize}
\begin{alltt}
int (*\textbf{get_root})(inode_t *inode);
uint32_t (*\textbf{allocate_block})(
    fdesc_t *file, int purpose,
    chdesc_t **head);
int (*\textbf{free_block})(
    fdesc_t *file, uint32_t block,
    chdesc_t **head);
bdesc_t *(*\textbf{lookup_block})(uint32_t number);
int (*\textbf{write_block})(
    bdesc_t *block, chdesc_t **head);
int (*\textbf{lookup_name})(
    inode_t parent, const char *name,
    inode_t *inode);
fdesc_t *(*\textbf{lookup_inode})(inode_t inode);
void (*\textbf{free_fdesc})(fdesc_t *fdesc);
uint32_t (*\textbf{get_file_numblocks})(fdesc_t *file);
uint32_t (*\textbf{get_file_block})(
    fdesc_t *file, uint32_t offset);
int (*\textbf{get_dirent})(
    fdesc_t *file, struct dirent *entry,
    uint16_t size, uint32_t *basep);
int (*\textbf{append_file_block})(
    fdesc_t *file, uint32_t block,
    chdesc_t **head);
uint32_t (*\textbf{truncate_file_block})(
    fdesc_t *file, chdesc_t **head);
fdesc_t *(*\textbf{allocate_name})(
    inode_t parent, const char *name,
    uint8_t type, fdesc_t *link,
    inode_t *newinode, chdesc_t **head);
int (*\textbf{remove_name})(
    inode_t parent, const char *name,
    chdesc_t **head);
int (*\textbf{rename})(
    inode_t oldparent, const char *oldname,
    inode_t newparent, const char *newname,
    chdesc_t **head);
int (*\textbf{get_metadata})(
    inode_t inode, uint32_t id,
    size_t size, void *data);
int (*\textbf{set_metadata})(
    inode_t inode, uint32_t id,
    size_t size, const void *data,
    chdesc_t **head);
\end{alltt}
\end{scriptsize}
\end{tabular}
\vspace{-10pt}
\caption{\label{fig:lfs} Important functions in the \LFS\ interface.}
\end{figure}

The \LFS\ interface (Figure~\ref{fig:lfs}) has functions to allocate blocks, add
blocks to files, allocate file names, and other file system micro-ops. A
\module\ implementing the \LFS\ interface should define how bits are laid out on
the disk, but doesn't have to know how to combine the micro-ops into larger,
more familiar file system operations. A generic CFS-to-\LFS\ \module\ decomposes
the larger file write, read, append, and other standard operations into \LFS\
micro-ops. This module, called UHFS, is described in the next section.

Each \chdesc\ on a cached block may or may not be visible to a given \module.
For example, \modules\ that respond to user requests generally view the most
current state of every block -- the block with all \chdescs\ applied. However, a
write-back cache may choose to write some \chdescs\ on a block while reverting
others, since those others currently have unsatisfied \befores. In this case,
\modules\ below the write-back cache (i.e. closer to the disk) should view the
unsatisfied \chdescs\ in the reverted state. \Kudos\ provides a block
revisioning library function that automatically rolls back those \chdescs\ that
should not be visible at a particular \module, and then rolls them forward again
after that \module\ is done with the block.
