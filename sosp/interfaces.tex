% -*- mode: latex; tex-main-file: "paper.tex" -*-

%% \subsection {Interfaces}
\label{sec:modules:interfaces}

\begin{comment}
New \modules\ are
simple to write, and by changing the \module\ arrangement, a broad range of
behaviors can be implemented. It's also easy to tell what behavior a given
arrangement will give just by looking at the connections between the \modules.
\end{comment}

A complete \Kudos\ configuration is composed of many \modules, making it
a finer-grained variant of a stackable file system.
%
There are has three major types of \modules.
%
Closest to the disk are block device (BD) \modules, which have a fairly
conventional block device interface with interfaces such as ``read block'' and
``flush''. 
%
Closest to the system call interface are \emph{common file system} (CFS)
\modules, which have an interface similar to VFS~\cite{kleiman86vnodes}. 
%
\Kudos\ also supports an intermediate interface between BD and CFS.
%
This \emph{low-level file system} (\LFS) interface helps divide file system
implementations into common (reusable) code and file system specific code. 
%
\begin{comment}
A
\Kudos\ file system designer combines modules with all three interfaces in many
ways -- a departure from stackable file systems, which act only at the VFS/CFS
layer. \Kudos\ \modules\ are implemented in C using structures of function
pointers to achieve object oriented behavior, very much like the rest of the
Linux kernel.
\end{comment}
%
The \LFS\ interface has functions to allocate blocks, add blocks to files,
allocate file names, and other file system micro-operations. A \module\ implementing
the \LFS\ interface should define how bits are laid out on the disk, but doesn't
have to know how to combine the micro-operations into larger, more familiar file system
operations. A generic CFS-to-\LFS\ \module\ decomposes the larger file write,
read, append, and other standard operations into \LFS\ micro-operations. This module,
called UHFS, is described in the next section.

Each \chdesc\ on a cached block may or may not be visible to a given \module.
For example, \modules\ that respond to user requests generally view the most
current state of every block -- the block with all \chdescs\ applied. However, a
write-back cache may choose to write some \chdescs\ on a block while reverting
others, since those others currently have outstanding dependencies. In this
case, \modules\ below the write-back cache (i.e. closer to the disk) should view
those \chdescs\ in the reverted state. \Kudos\ provides a block revisioning
library function that automatically rolls back those \chdescs\ that should not
be visible at a particular \module, and then rolls them forward again after that
\module\ is done with the block.
