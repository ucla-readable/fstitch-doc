\section{Related Work}
\label{sec:related}

\paragraph{Consistency}

Soft updates~\cite{ganger00soft} significantly lowers the overhead required to
provide file system consistency. By carefully ordering writes to disk, soft
updates avoids the need for synchronous writes to disk or duplicate writes to
a journal. Soft updates also guarantees a strong level of consistency after a
crash, enough so that the system can avoid time-consuming file system
consistency checks using a utility like \emph{fsck}. 
%
A comparable approach to protecting the integrity of the file
system~\cite{seltzer00journaling} is to write
upcoming operations to a journal first. The content and the layout of the
journal vary in each implementation, but in all cases, the system can use the
journal to play out (or roll back) the operations that did not complete as a
result of a crash. Thus, \emph{fsck} can be avoided by consulting the journal
when recovering from a crash.  Section \ref{sec:using:journal} explains
journaling with \patches.

External synchrony~\cite{nightingale06rethink} builds on journaling to
automatically provide strict file system operation ordering for applications,
without requiring them to block on each write. It combines operations into a
journal, but tracks the activity of the calling processes after returning
control to them from the file system. If a process later performs some
\emph{user-visible} operation like printing text to the screen or sending
network traffic, the journal transaction containing the changes is forced to
commit before the process can continue.
%
External synchrony depends inherently on dependency tracking; dependencies
among processes with outstanding data are tracked to ensure that
uncommitted output never reaches a user. However, it also depends on a
particular file system consistency methodology, namely journaling, and it
is implemented only in an ext3-like file system called xsyncfs. \Kudos\
\patch\ dependencies could be a natural implementation strategy for its
dependencies, allowing them to apply to any file system.
%
Similar \patch-like dependencies are used to improve network file system
performance in BlueFS~\cite{nightingale05speculative}.

Customizable application-level consistency protocols have previously been
considered in the context of distributed, parallel file systems by
CAPFS~\cite{vilayannur05providing} and Echo~\cite{mann94coherent}.
%
CAPFS allows application writers to design plug-ins for a parallel file store
that define what actions to take before and after each client-side system
call.
%
These plug-ins can enforce additional consistency policies.
%
Echo maintains a partial order on the locally cached updates to the remote file
system, and guarantees that the server will store the updates accordingly. It
also provides a mechanism for applications to extend the partial order, thus
reducing the server's flexibility to choose how to write the data or make it
available to other clients.
%
Both systems are based on the principle that not providing the right
consistency protocol can cause unpredictable failures, yet enforcing
unnecessary consistency protocols can be extremely expensive.
%
However, this is also true with a local file system, and as a result
applications currently use expensive interfaces like \texttt{fsync()} when
they require specific consistency guarantees.
%
\Kudos\ \patchgroups\ bring this sort of customizable consistency to all
applications, not just those using specialized distributed file systems.

A similar application interface to \patchgroups\ is explored in
Section~4 of Burnett's thesis~\cite{burnett06information}. However, the methods
used to implement the interfaces are very different: Burnett's system tracks
dependencies at the level of entire system calls, associates dirty blocks with
unique IDs returned by those calls, and duplicates dirty blocks when necessary
to preserve ordering. \Kudos\ tracks individual changes to blocks internally,
allowing kernel modules a finer level of control, and only chooses to expose a
userspace interface similar to Burnett's as a means to simplify the sanity
checking which is required of arbitrary user-submitted requests.

Additionally, Burnett's system is evaluated using trace-driven simulations
rather than an implementation. We have found that some aspects of real disks
have significant impacts which his simulator may not have taken into account;
for instance, we have found that the number of I/O requests to the disk, rather
than the theoretical seek time or the number of blocks accessed, can be a
bottleneck.

% "allow the kernel to safely and efficiently handle any metadata layout without understanding the layout itself"
% \cite{kaashoek97application}

\paragraph{Stackable File Systems}

% \cite{webber93portable}

Stackable \module\ software for file systems continues to attract active
research~\cite{rosenthal90evolving, heidemann91layered, skinner93stacking,
heidemann94filesystem,zadok99extending,
zadok00fist,wright03ncryptfs,wright06versatility}. Previous
systems like FiST~\cite{zadok00fist} or GEOM~\cite{geom} generally focus on
an individual portion of the system and thus restrict both what a \module\
can do and how \modules\ can be arranged. FiST, for instance, does not
provide a way to deal with structures on the disk directly -- it provides
only ``wrapper'' functionality around existing file
systems. %% (Wrapfs~\cite{zadok99stackable, zadok99extending} is similar.)
GEOM, on the other hand, deals only with the block device layer, and has no
way to work with the file systems stored on those block devices. Neither
has a formal way of specifying or honoring complex write-ordering
information, which is what \patches\ in \Kudos\ provide. We imagine that
systems like these could be adapted to work with \patches, giving the
benefits of both ideas.

\paragraph{Applications}

A variety of extensions to file systems and disk interfaces have been proposed
in recent work, like the FS2 Free Space File System~\cite{huang05fs2},
encrypting file systems like NCryptfs~\cite{wright03ncryptfs}, and type-safe
disks~\cite{sivathanu06typesafe}. The \Kudos\
\module\ system may provide an interesting platform for implementations 
of these ideas.
%% NCryptfs has been written in a
%% stackable way already, allowing it to be easily adapted for new underlying file
%% systems -- but FS2 is currently specific to ext2, since it deals directly with
%% low-level disk structures. The \Kudos\ \module\ interface should allow such an
%% extension to be written in a portable way, giving it the same benefit.

\paragraph{} \Kudos\ adds to this body of work by generalizing and making
explicit the ``write before'' relationship that is already present in many
storage systems, and making it a pervasive primitive throughout the storage
system. This allows many different consistency models to be created and
combined in file system independent ways, and it provides a means for file
system extensions to deal directly with consistency. It also allows the
extension of this concept into userspace, so that even user applications
can easily use this functionality.
