\subsection{\Nrb\ \ChDescs}
\label{sec:chdescs:nrb}

Each data\todo{Name?} \chdesc\ contains a copy of its block's previous data to
allow rollback\footnote{Actually, \Kudos\ supports a specialized type of \chdesc\ for
efficiently flipping individual bits using an inline exclusive-or mask instead
of a copy of the previous data, but most \chdescs\ are not of this type.}.
%
In practice, many \chdesc\ are never actually rolled back (e.g. file
data blocks)
%
and the previous data copies nearly double the combined memory usage of
\chdescs\ and cached blocks.
%
To avoid this overhead, \Kudos\ identifies \chdescs\ that will never
need to be rolled back and omits their previous data copies. We call
these \emph{\nrb} \chdescs. (The opposite naturally being a \emph{\rb}
\chdesc, when necessary to differentiate them.)
%
Since a \nrb\ \chdesc\ cannot be rolled back, a write of any \chdescs\
on block $B$ must include all \nrb\ \chdescs\ on $B$. To accordingly
update our formal model we define a new set of \chdescs, \PHard, which
contains all \nrb\ \chdescs. We write \PHard[B] to restrict the set
to block $B$\todo{Introduce \PSoft\ and \PSoft[B].}:

\begin{tabbing}
\textbf{Write block.} \\
\quad Pick some block $b$ with $\PMem[b] \neq \emptyset$. \\
\quad Pick some $P \subseteq \PMem[b]$ with $\PDepset{P} \subseteq P \cup
\PDisk$ and $\PHard[B] \subseteq P$. \\
\quad For each $p \in P$, set $\PState{p} \gets \PInfst$. \\
\quad For each $p \in \PMem[b]-P$, set $\PDDepset{p} \gets \PDDepset{p}
\cup P$.
\end{tabbing}

\paragraph{}
To avoid (expensive) dependency traversals to determine whether a new
\chdesc\ will need to be rolled back,
%
\Kudos\ conservatively identifies \nrb\ \chdescs\ using only local
dependency information.
%
\Kudos\ detects that a new \chdesc\ on block $b$ may need to be rolled back if:
\todo{Which form is easier to read? Can we write \(\PMem - \PMem[b] - \PEmpty\) more concisely?}
%
\todo{Actually, our implementation also uses in flight \chdescs. Can we make
it not?}
%
\[ \PRDepset{\PMem[b]} \cap (\PMem - \PMem[b] - \PEmpty) \ne \emptyset \]
\[ \exists \inset{p}{\PMem[b]}\!:\
   \exists c\!:\ \exists \inset{q}{\PMem[c]}\!:\
   \indirdepends{q}{p} \]
%
This is both a safe and useful indicator because
%
the presence of an external \after\ is a necessary condition for a new
\chdesc's \before\ to induce a block-level cycle
%
and many blocks have no \chdescs\ with external \afters\ (e.g. most
file data blocks).

While this algorithm detects whether a \chdesc\ may need to be rolled
back, \Kudos\ must also be sure that no future dependency manipulation
will cause the \chdesc\ to require a rollback.
%
We introduce Invariant~\ref{cdinvar:add-before} to support such reasoning:
%
\cdinvar{add-before}{All block-level cycles induced through
\chdesc\ \p{p}'s \befores\ exist when \p{p} is
created\todo{Change this phrasing? ``Once created, a \chdesc\ will not
gain any \befores\ that induce block-level cycles.''}.}
%
\noindent \Kudos\ ensures this invariant by restricting \before\
additions to \chdesc\ creation, \noop\ \chdescs\ with no \afters, or
when the invariant is statically proven to hold for the affected
\chdescs.
