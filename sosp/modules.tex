\section{\Modules}
\label{sec:modules}

This section describes several \Kudos\ \modules\ which contribute significantly
to the overall functionality of \Kudos, or which demonstrate unique or
important capabilities of \chdescs\ and the \module\ system. Some \modules,
like the journal \module\ and the write-back cache, have already been described
(see \S\ref{sec:using:journal} and \S\ref{sec:using:wbcache}), while others
like the write-through cache, partitioner, and memory block device, have
functions which are fairly obvious from their names and need no further
description.

\input{interfaces}

\input{uhfs}

\subsection{Loopback Block Device}
\label{sec:modules:loop}

The loopback block device is a BD module which uses a file in an LFS module as
its underlying data store. It is very similar to the device of the same name in
Linux, however it has one critical difference. The \Kudos\ loopback device is
aware of \chdescs, and therefore when a filesystem stored on a loopback device
sets up \chdesc\ dependencies, they will be correctly forwarded to and honored
by the rest of the system.

\begin{figure}[htb]
  \centering
  \includegraphics[height=3in]{fig/figures_1}
  \caption{A running \Kudos\ configuration. {\it/} is a soft updated
    file system on an IDE drive; {\it/loop} is an externally journaled
    file system on loop devices.}
  \label{fig:kfs-graph}
\end{figure}

Figure~\ref{fig:kfs-graph} shows an example configuration taking advantage of
this ability. A file system image is mounted with an external journal, both of
which are loopback block devices stored on the root file system, (which uses
soft updates). The journaled file system's ordering requirements are sent
through the loopback device as \chdescs, allowing dependency information to be
maintained across boundaries that might otherwise lose that information. In
contrast, without \chdescs\ and the ability to forward \chdescs\ through
loopback devices, BSD cannot express soft updates' consistency requirements
through loopback devices. The \modules\ in Figure~\ref{fig:kfs-graph} are a
complete and working \Kudos\ configuration, and although the use of a loopback
device is somewhat contrived in the example, they are increasingly being used in
conventional operating systems. For instance, Mac OS X uses them in order to
allow users to encrypt their home directories.

\input{ext2}
\input{ufs}

\subsection{Case Insensitivity}
\label{sec:modules:icase}
\Kudos\ provides a case insensitivity \module\ at the CFS layer. It
allows file systems such as UFS and ext2, which inherently handle filenames
case sensitively, to become case insensitive in this regard. So now if a user
needs to run an application that expected the underlying filename semantics
to be case insensitive, on top of a case sensitive file system, they would
merely enable the module. This is also a great testament to the flexibility
of \Kudos's modular abstractions. By allowing a module to intercept actions
between the CFS and \LFS\ layers, filename transformations can be made
transparently for the user regardless of the on-disk storage format of
the actual filename.

\subsection{\ChDesc\ Unlinking}
\label{sec:modules:unlink}
In the event that no consistency semantics are desired, for instance to compare
a prototype implementation of a system for working with explicit dependency
information to an existing asynchronous file system like ext2, \Kudos\ provides
a \module\ which unlinks the dependencies from all \chdescs\ passing through it.
By using this \module, the \chdesc\ graph will not enforce any ordering at all,
and the buffer cache will be free to write blocks in any order. \Chdescs\ are
not really necessary to implement this ``consistency'' protocol, but they
nevertheless support it as a degenerate case.

\todo{sync directory}
\todo{file hiding}
\todo{umsdos?}
