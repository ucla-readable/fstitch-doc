\section*{Introduction}
\label{sec:intro}

Despite the recent proliferation of advanced filesystem consistency
features, such as journalling and soft updates~\cite{ganger00soft},
the software which implements these features remains largely
inflexible and difficult to reason about. It is generally tied to a
particular filesystem, and can neither be reused in another filesystem
nor adapted to allow even slightly different semantics without
significant engineering effort. To address this problem, we propose a
new system called the KudOS File Server Architecture which introduces
two significant changes to traditional designs. 
%
First, \emph{change descriptor} structures represent any and all changes to
stable storage.
%
File system implementations generate change descriptors when blocks are
written and forward them to block devices for eventual commit.
%
Each change descriptor stores the old state of the block and its
\emph{dependencies}: a set of other change descriptors that must be
committed before it is safe to commit this change.
%
Explicit dependencies let KudOS modules preserve necessary file system
invariants, without understanding the file system itself; the old state
lets KudOS roll back changes when necessary to break cycles.
%
Change descriptors are general enough to implement many ways of achieving
consistency, including soft updates and journaling.
%
%
%
Second,
we decompose the filesystem software into small modules and add a new
interface type between the block device interface and the abstract
filesystem interface.  This interface separates the low-level
specification of a filesystem's on-disk layout from higher-level
filesystem-independent code which operates only abstractly on disk
structures.

We have implemented a mostly-complete, functional prototype of the KFS
Architecture. In our prototype, these two changes greatly increase the
flexibility of standard consistency features, allowing our journalling
module to automatically add journalling to any filesystem. They also support
the implementation of many other possible definitions of filesystem
consistency, which in the future we hope will allow for userspace
specification. Finally, the module system combined with the dependency
tracking mechanism allows interesting new interactions, such as correct
consistency on RAID over loopback devices.
