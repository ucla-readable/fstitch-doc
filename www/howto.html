<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
	"http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta http-equiv="Content-Language" content="en">

	<title>Featherstitch</title>

	<link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>

<div id="content">

	<h1>Downloading and using Featherstitch</h1>

	<h2>Getting the source</h2>

	<p>
	The Featherstitch sources are maintained in a source repository of
	some sort. (We haven't decided between svn and git just yet.)
	Anyway, you need to follow some instructions that we haven't posted
	yet to get them. Check back here later.
	</p>

	<p>
	For example, you might potentially be able to do this:
	</p>
	<div class="code">
	svn co http://featherstitch.cs.ucla.edu/svn/trunk/fstitch ~/fstitch
	</div>

	<h2>Configuring your kernel</h2>

	<p>
	Currently, Featherstitch is incompatible with a few Linux
	configuration options which are often enabled by default.
	Eventually we'd like to eliminate this problem, but for the time
	being, you will need to disable them in your kernel to compile and
	run Featherstitch. The list is:
	</p>
	<ul class="small">
	<li><tt>CONFIG_SMP</tt></li>
	<li>On older 2.6 kernels: <tt>CONFIG_PREEMPT</tt></li>
	<li>On newer 2.6 kernels: all <tt>CONFIG_PREEMPT_*</tt> except <tt>CONFIG_PREEMPT_NONE</tt></li>
	<li><tt>CONFIG_LBD</tt></li>
	</ul>

	<p>
	We also recommend a few settings to make sure all of our scripts
	work well, and to enable additional debugging options:
	</p>
	<ul class="small">
	<li><tt>CONFIG_PROC_FS</tt></li>
	<li><tt>CONFIG_IKCONFIG</tt></li>
	<li><tt>CONFIG_IKCONFIG_PROC</tt></li>
	<li><tt>CONFIG_SYSFS</tt></li>
	<li><tt>CONFIG_DEBUG_FS</tt></li>
	<li><tt>CONFIG_MAGIC_SYSRQ</tt></li>
	<li><tt>CONFIG_DEBUG_KERNEL</tt></li>
	<li><tt>CONFIG_DETECT_SOFTLOCKUP</tt></li>
	</ul>

	<p>
	The kernel .config files we use for Linux 2.6.20.1 are available:
	<a href="config-2.6.20.1-fstitch-debug">for debugging</a>,
	<a href="config-2.6.20.1-fstitch-prof">for profiling</a>, and
	<a href="config-2.6.20.1-fstitch-fast">for benchmarking</a>.

	<h2>Patching your kernel</h2>

	<p>
	While you can use Featherstitch with an unmodified Linux
	kernel, you will likely want to apply some or all of the patches below.
	The commands below assume Linux 2.6.20.1 sources in
	<tt>~/linux-2.6.20.1</tt> and Featherstitch in <tt>~/fstitch</tt>.
	</p>

	<h3>Patchgroups</h3>

	<p>
	Patchgroup support requires kernel process notifications to manage
	the per-process patchgroup tables:
	</p>
	<div class="code">
	cd ~/linux-2.6.20.1<br>
	patch -p1 &lt; ~/fstitch/patches/fstitch-linux-2.6.20.1.patch
	</div>
	<p>
	You will also need to reconfigure your kernel to enable the new
	<tt>CONFIG_FSTITCH_PROC</tt> option (in the "File systems" section).
	The config files above have this option enabled already.
	</p>

	<h3>Disk safety</h3>

	<p>
	For Featherstitch to know when a disk write is committed to stable
	storage you must either enable FUA disk I/O or switch the disk's
	cache to write-through mode. In our experience their performance
	is the same, but FUA is more flexible (e.g., each I/O request
	can select whether to actually use FUA).
	</p>

	<p>		
	For FUA disk I/O, patch the kernel (recommended):
	</p>
	<div class="code">
	cd ~/linux-2.6.20.1<br>
	patch -p1 &lt; ~/fstitch/patches/bio-fua-2.6.20.1.patch
	</div>

	<p>
	Alternately, switch the disk's cache to write-through mode:
	</p>
	<div class="code">
	hdparm -W 0 /dev/&lt;DISK&gt;
	</div>

	<h3>Remote operation</h3>

	<p>
	Although <a href="http://www.linuxjournal.com/article/1026">Linux
	can execute an infinite loop in 6 seconds</a>, occasionally we have
	seen one of our loops run just a bit longer than that. When this
	happens locally, we power cycle the machine, but when we're working
	on a crashbox remotely, it can be a bit of a drag. So, we made a
	patch for the soft lockup detector in Linux that reboots after
	about a minute of soft lockup, which we suspect nearly always means
	an infinite loop. To apply it, do this:
	</p>
	<div class="code">
	cd ~/linux-2.6.20.1<br>
	patch -p1 &lt; ~/fstitch/patches/softlockup-2.6.20.1.patch
	</div>
	<p>
	You'll also need to make sure you've got
	<tt>CONFIG_DETECT_SOFTLOCKUP</tt> enabled.
	</p>

	<h2>Compiling and loading Featherstitch</h2>

	<p>
	You should be able to run <tt>make</tt> in the <tt>fstitch</tt>
	directory at this point, and Featherstitch should detect what
	kernel features are available and compile correctly. (Please let us
	know if you encounter any compile errors!) The Featherstitch kernel
	module will be created as <tt>fscore/kfstitchd.ko</tt>. It has
	several <tt>insmod</tt> options that affect how it searches for and
	mounts supported file systems. Here are a few of the more useful
	options:
	</p>
	<ul class="small">
	<li><tt>device</tt>: The block device to scan for supported file systems</li>
	<li><tt>use_journal</tt>: Set to 1 (or 2) to use metadata (or full) journal_bd when .journal exists</li>
	<li><tt>use_unlink</tt>: Set to 1 to use the unlink device for asynchronous writes</li>
	<li><tt>use_crashsim</tt>: Set to 1 to use the crash simulator device</li>
	</ul>
	<p>
	The full list of supported options can be listed with this command:
	</p>
	<div class="code">
	modinfo fscore/kfstitchd.ko
	</div>

	<p>
	For instance, to load Featherstitch using <tt>/dev/sdb</tt> and
	metadata journaling, you would do:
	</p>
	<div class="code">
	sudo insmod fscore/kfstitchd.ko device=/dev/sdb use_journal=1
	</div>

	<p>
	Once Featherstitch is loaded, the file system(s) it detects can be
	mounted using commands like:
	</p>
	<div class="code">
	sudo mount -t fstitch fstitch:/ /mnt<br>
	sudo mount -t fstitch fstitch:/dev /mnt/dev
	</div>

	<p>
	Eventually, we'd like to have a configuration file that determines
	how Featherstitch starts up. For now, there is code in
	<tt>fscore/fstitchd_init.c</tt> that detects disks, partitions, and
	file systems, and instantiates Featherstitch modules to use them.
	Some of its behavior can be adjusted using the <tt>insmod</tt>
	parameters, but you may need to edit this source file if you want
	to create a very different module configuration.
	</p>

	<h2>Using patchgroups</h2>

	<p>
	Coming soon.
	</p>

	<h2>Debugging Featherstitch</h2>

	<p>
	Featherstitch includes a built-in patch debugger. To enable it, set
	<tt>FSTITCH_DEBUG</tt> to <tt>1</tt> in <tt>fscore/debug.h</tt> and
	recompile. When Featherstitch is loaded, it will create a file
	<tt>/proc/kfstitchd_debug</tt> which should be read and saved
	somewhere outside of the Featherstitch file system(s). This file
	will contain a (binary) trace of most patch-related changes inside
	of Featherstitch, and is very useful for debugging both correctness
	and performance problems. Using this option does, however, slow
	Featherstitch down somewhat.
	</p>

	<p>
	To analyze these debug traces, there is a utility called
	<tt>kdb</tt> which will be created as <tt>obj/util/kdb</tt> when
	Featherstitch is compiled. It can step through the traces and allow
	you to examine the status of all patches and dependencies in the
	system, as well as render a graphical representation of the patches
	at each step. (For this feature, you must have the "graphviz"
	package installed, and specifically, its <tt>dot</tt> program.) It
	has some brief documentation built in - try the "help" command.
	(Also try the "gui" command, which is very useful and gives
	debugging Featherstitch a unique sound: "click, click, click...")
	</p>

	<!--
	<p>
	Some example diagrams the debugger has created are available:
	<a href="small.png">small</a>,
	<a href="medium.png">medium</a>,
	<a href="large.png">large</a>,
	<a href="huge.ps.gz">huge</a>,
	<a href="enormous.ps.gz">enormous</a>,
	<a href="gargantuan.ps.gz">gargantuan</a>,
	<a href="monumental.ps.gz">monumental</a>,
	<a href="leviathan.ps.gz">leviathan</a>,
	<a href="titanic.ps.gz">titanic</a>,
	<a href="colossal.ps.gz">colossal</a>,
	<a href="epic.ps.gz">epic</a>,
	and <a href="vast.ps.gz">vast</a>.
	</p>
	-->

	<h2>Userspace Featherstitch</h2>

	<p>
	Featherstitch can also run as a FUSE file server process in
	userspace. In this mode, patchgroups are not available, and instead
	of the kernel block device layer, files in the normal Linux file
	system are used as block devices.
	</p>

	<p>
	First, you'll need FUSE (we use 2.5.2). You'll
	also need to copy <tt>fstitch/conf/fuse.conf</tt> to <tt>/etc</tt>,
	and, if you want to run Featherstitch in <tt>valgrind</tt>, you'll
	need to put <tt>fstitch/util/fusermount</tt> in your <tt>PATH</tt>
	(after modifying it to point to the location of the real
	<tt>fusermount</tt>).
	
	</p>

	<p>
	Assuming FUSE is installed in <tt>/usr/local</tt>, you could:
	</p>
	<div class="code">
	sudo cp ~/fstitch/conf/fuse.conf /etc<br>
	export PATH=~/fstitch/util:$PATH
	</div>

	<p>
	Once FUSE is set up, you should be able to run <tt>make -f
	Makefile.user</tt>, or, if you want to compile both Featherstitch
	targets, just:
	</p>
	<div class="code">
	cd ~/fstitch<br>
	touch .user<br>
	make
	</div>

	<p>
	After compiling, you can start Featherstitch by running
	<tt>uufstitchd.sh</tt>, which accepts many of the same options as
	the kernel version does. (However, the <tt>device=</tt> parameter
	is instead called <tt>unix_file</tt>. Or, it can be passed positionally.)
	An example disk image is
	provided and built automatically as <tt>obj/fs/ext2.img</tt>. Here
	is a simple example command to start userspace Featherstitch:
	</p>
	<div class="code">
	./uufstitchd.sh mnt/ obj/fs/ext2.img
	</div>
	And an example which uses the unlink module for asynchronous writes:
	<div class="code">
	./uufstitchd.sh mnt/ unix_file=obj/fs/ext2.img use_unlink=1
	</div>

	<p>
	To run Featherstitch inside <tt>gdb</tt> or <tt>valgrind</tt>, use
	the <tt>FSTITCHD_WRAP</tt> environment variable:
	</p>
	<div class="code">
	FSTITCHD_WRAP=gdb ./uufstitchd.sh unix_file=obj/fs/ext2.img
	</div>

	<p>
	To shut down userspace Featherstitch, simply hit <tt>^C</tt>.
	</p>

	<h2>Questions? Comments?</h2>

	<p>
	Click below, subscribe to our mailing list, and send us your questions and comments:<br>
	<form action="/cgi-bin/mailman.cgi" method=POST>
	<input type=hidden name="list" value="featherstitch">
	<input type=image src="images/fstitch.png" alt="featherstitch list">
	</form>
	You can also try looking for us in #fstitch on irc.gimp.org.<br><br>
	</p>

</div>

<script src="http://www.google-analytics.com/urchin.js" type="text/javascript">
</script>
<script type="text/javascript">
_uacct = "UA-2452644-1";
urchinTracker();
</script>

</body>
</html>
