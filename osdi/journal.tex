\subsection{Journaling}
\label{sec:consistency:journal}

% FIXME: What is the on-disk layout of the resulting journal? Remove
% the NOOP stuff back to Section 3; here just say you're using them.

Although \chdescs\ might initially seem to be specifically designed to
implement soft updates-like consistency semantics, they are in fact much more
flexible and can be used to implement journaling as well. What distinguishes
journaling from soft updates (from the point of view of \chdescs\ and
the write-back cache) is that with soft updates, \chdescs\ can always
be written to the disk in order to empty the cache, while journals can
``lock'' changes into the cache when transactions are in progress.

To accomplish this, journal \module\ makes all \chdescs\ passing through it
depend on a managed \noop\ \chdesc (\S\ref{sec:design:chdescs:noop}), and makes
copies of them to write to the journal. When the transaction is over, it creates
a commit record, sets all the \chdescs\ in the transaction to depend on it, and
satisfies the managed \noop\ \chdesc.

\begin{figure}
  \centering
  \includegraphics[width=\hsize]{fig/figures_2}
  \caption{\label{fig:journal} Journal \chdesc\ graph for the
    change in Figure~\ref{fig:softupdate}. Empty circles are
    ``\noop'' \chdescs\ with no associated block data.}
\end{figure}

For example, the \chdescs\ in Figure~\ref{fig:softupdate} can be transformed to
provide journaling semantics. The original four \chdescs\ are modified to depend
on a journal commit record, which depends on blocks journaling the changes. This
transformation is performed incrementally as \chdescs\ arrive. Once the actual
changes commit, the journal record is marked as completed.
Figure~\ref{fig:journal} shows these transformed \chdescs.

A particularly nice property of this arrangement is that the journal \module\ is
completely independent of any specific file system. It is a block device
\module\ that automatically journals whatever file system is stored on it.
Further, by changing our journal \module\ to journal only \chdescs\ that modify
file system metadata -- and by adding additional dependencies to prevent
premature reuse of blocks -- we could even obtain metadata-only journaling (as
opposed to the full data journaling described here). The extra \chdesc\
dependencies would serve the same purpose as the special hooks and corner cases
surrounding reuse of blocks discussed in \cite{tweedie00ext3}. The journal
\module\ can automatically identify metadata \chdescs\ because of the LFS
interface described in \S\ref{sec:design:interfaces}. Other block device
layering systems, like GEOM~\cite{geom} or JBD in Linux, would or do need
special hooks into file system code to determine what disk changes represent
metadata in order to do metadata-only journaling. \Chdescs\ and the LFS
interface allow us to do this automatically.
